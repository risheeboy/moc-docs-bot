{
  "family": "ragqa-api-gateway",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "2048",
  "memory": "4096",
  "containerDefinitions": [
    {
      "name": "api-gateway",
      "image": "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/ragqa/api-gateway:${IMAGE_TAG}",
      "portMappings": [
        {
          "containerPort": 8000,
          "hostPort": 8000,
          "protocol": "tcp"
        }
      ],
      "essential": true,
      "environment": [
        {
          "name": "PYTHONUNBUFFERED",
          "value": "1"
        },
        {
          "name": "APP_ENV",
          "value": "production"
        },
        {
          "name": "APP_DEBUG",
          "value": "false"
        },
        {
          "name": "APP_LOG_LEVEL",
          "value": "INFO"
        },
        {
          "name": "AWS_DEFAULT_REGION",
          "value": "ap-south-1"
        },
        {
          "name": "JWT_ALGORITHM",
          "value": "HS256"
        },
        {
          "name": "JWT_ACCESS_TOKEN_EXPIRE_MINUTES",
          "value": "60"
        },
        {
          "name": "JWT_REFRESH_TOKEN_EXPIRE_DAYS",
          "value": "7"
        },
        {
          "name": "POSTGRES_PORT",
          "value": "5432"
        },
        {
          "name": "POSTGRES_DB",
          "value": "ragqa"
        },
        {
          "name": "REDIS_PORT",
          "value": "6379"
        },
        {
          "name": "REDIS_DB_CACHE",
          "value": "0"
        },
        {
          "name": "RATE_LIMIT_ADMIN",
          "value": "120"
        },
        {
          "name": "RATE_LIMIT_EDITOR",
          "value": "90"
        },
        {
          "name": "RATE_LIMIT_VIEWER",
          "value": "30"
        },
        {
          "name": "RATE_LIMIT_API_CONSUMER",
          "value": "60"
        },
        {
          "name": "SESSION_IDLE_TIMEOUT_SECONDS",
          "value": "1800"
        },
        {
          "name": "SESSION_MAX_TURNS",
          "value": "50"
        },
        {
          "name": "SESSION_CONTEXT_WINDOW_TOKENS",
          "value": "4096"
        },
        {
          "name": "RAG_SERVICE_URL",
          "value": "http://rag-service.ragqa.local:8001"
        },
        {
          "name": "LLM_SERVICE_URL",
          "value": "http://llm-service.ragqa.local:8002"
        },
        {
          "name": "SPEECH_SERVICE_URL",
          "value": "http://speech-service.ragqa.local:8003"
        },
        {
          "name": "TRANSLATION_SERVICE_URL",
          "value": "http://translation-service.ragqa.local:8004"
        },
        {
          "name": "OCR_SERVICE_URL",
          "value": "http://ocr-service.ragqa.local:8005"
        },
        {
          "name": "INGESTION_SERVICE_URL",
          "value": "http://data-ingestion.ragqa.local:8006"
        },
        {
          "name": "TRAINING_SERVICE_URL",
          "value": "http://model-training.ragqa.local:8007"
        },
        {
          "name": "LANGFUSE_HOST",
          "value": "http://langfuse.ragqa.local:3001"
        }
      ],
      "secrets": [
        {
          "name": "APP_SECRET_KEY",
          "valueFrom": "${SECRET_ARN_PREFIX}app-secret-key"
        },
        {
          "name": "JWT_SECRET_KEY",
          "valueFrom": "${SECRET_ARN_PREFIX}jwt-secret-key"
        },
        {
          "name": "POSTGRES_HOST",
          "valueFrom": "${SECRET_ARN_PREFIX}postgres-host"
        },
        {
          "name": "POSTGRES_USER",
          "valueFrom": "${SECRET_ARN_PREFIX}postgres-user"
        },
        {
          "name": "POSTGRES_PASSWORD",
          "valueFrom": "${SECRET_ARN_PREFIX}postgres-password"
        },
        {
          "name": "REDIS_HOST",
          "valueFrom": "${SECRET_ARN_PREFIX}redis-host"
        },
        {
          "name": "REDIS_PASSWORD",
          "valueFrom": "${SECRET_ARN_PREFIX}redis-password"
        },
        {
          "name": "LANGFUSE_PUBLIC_KEY",
          "valueFrom": "${SECRET_ARN_PREFIX}langfuse-public-key"
        },
        {
          "name": "LANGFUSE_SECRET_KEY",
          "valueFrom": "${SECRET_ARN_PREFIX}langfuse-secret-key"
        },
        {
          "name": "CORS_ALLOWED_ORIGINS",
          "valueFrom": "${SECRET_ARN_PREFIX}cors-allowed-origins"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/ragqa-api-gateway",
          "awslogs-region": "ap-south-1",
          "awslogs-stream-prefix": "ecs"
        }
      },
      "healthCheck": {
        "command": [
          "CMD-SHELL",
          "python -c \"import requests; requests.get('http://localhost:8000/health', timeout=5)\" || exit 1"
        ],
        "interval": 30,
        "timeout": 10,
        "retries": 3,
        "startPeriod": 15
      }
    }
  ],
  "taskRoleArn": "${TASK_ROLE_ARN}",
  "executionRoleArn": "${EXECUTION_ROLE_ARN}",
  "tags": [
    {
      "key": "Service",
      "value": "api-gateway"
    },
    {
      "key": "Component",
      "value": "core"
    }
  ]
}
