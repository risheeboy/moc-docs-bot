# ============================================================================
# Loki Configuration
# Log aggregation for RAG-Based Hindi QA System
# ============================================================================

auth_enabled: false

ingester:
  chunk_idle_period: 3m
  chunk_retain_period: 1m
  max_chunk_age: 2h
  chunk_encoding: snappy

  # WAL for durability
  wal:
    enabled: true
    dir: /loki/wal
    checkpoint_duration: 5m

  lifecycler:
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    num_tokens: 128
    heartbeat_timeout: 5m

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  ingestion_rate_mb: 10
  ingestion_burst_size_mb: 20
  max_streams_matchers_per_user: 10000
  max_global_streams_per_user: 10000
  max_entries_limit_per_minute: 100000
  max_cache_freshness_per_query: 10m
  split_queries_by_interval: 24h
  retention_period: 720h                        # 30 days default

schema_config:
  configs:
    - from: 2024-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v13
      index:
        prefix: loki_index_
        period: 24h
      row_shards: 16

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    shared_store: filesystem
    cache_location: /loki/boltdb-shipper-cache
  filesystem:
    directory: /loki/chunks

# ============================================================================
# CHUNK CACHE (Redis if available, otherwise in-memory)
# ============================================================================
chunk_cache_config:
  enable_fifocache: true
  default_validity: 1m
  background:
    writeback_goroutines: 10
    writeback_goroutines_per_shard: 1
  memcached_client:
    addresses: redis:6379
    consistent_hash: true
    update_interval: 1m
    max_idle_conns: 100

index_cache_validity: 5m

runtime_config:
  period: 10s
  file: /etc/loki/runtime.yml

# ============================================================================
# QUERY CONFIGURATION
# ============================================================================
querier:
  max_concurrent: 2048
  query_timeout: 5m
  query_ingesters_within: 3h
  engine: prometheus

# ============================================================================
# QUERY FRONTEND (caching layer)
# ============================================================================
query_range:
  align_queries_with_step: true
  max_cache_freshness_per_query: 10m
  cache_results: true
  results_cache:
    cache:
      enable_fifocache: true
      default_validity: 1m
      background:
        writeback_goroutines: 10

# ============================================================================
# DISTRIBUTOR (entry point)
# ============================================================================
distributor:
  rate_limit_enabled: true
  rate_limit_bytes: 10485760                    # 10MB/s per distributor
  rate_limit_strategies: global

# ============================================================================
# TABLE MANAGER (retention & compaction)
# ============================================================================
table_manager:
  retention_deletes_enabled: true
  retention_period: 720h                        # 30 days
  poll_interval: 10m
  creation_grace_period: 10m

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================
server:
  http_listen_port: 3100
  http_listen_address: 0.0.0.0
  log_level: info
  log_format: json
  grpc_listen_port: 9096
  grpc_listen_address: 0.0.0.0
  grpc_server_max_recv_msg_size: 67108864
  grpc_server_max_send_msg_size: 67108864
  grpc_server_max_concurrent_streams: 1000
  graceful_shutdown_timeout: 30s
  http_server_read_timeout: 30s
  http_server_write_timeout: 30s
  http_server_idle_timeout: 120s
  log_request_at_info_level_enabled: false

# ============================================================================
# METRICS
# ============================================================================
metrics:
  enabled: true
  backend: prometheus
  include_request_body: false
  include_response_body: false
