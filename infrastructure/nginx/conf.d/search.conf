# ============================================================================
# Search Page SPA Routes
# ============================================================================

location ~ ^/search/?$ {
    limit_req zone=search_limit burst=50 nodelay;
    limit_conn addr 10;

    # Serve search page SPA
    proxy_pass http://search-page;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache SPA shell
    proxy_cache_valid 200 1h;
    proxy_cache_use_stale error timeout invalid_header updating;
}

location ~ ^/search/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    limit_req zone=search_limit burst=100 nodelay;

    proxy_pass http://search-page;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Cache static assets aggressively
    proxy_cache_valid 200 30d;
    add_header Cache-Control "public, immutable, max-age=2592000";
    access_log off;
}

location ~ ^/search/api/ {
    # Search API calls go through API gateway
    limit_req zone=search_limit burst=50 nodelay;

    proxy_pass http://api_gateway;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $http_x_request_id;

    proxy_connect_timeout 30s;
    proxy_read_timeout 60s;
}
