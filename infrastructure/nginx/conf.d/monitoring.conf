# ============================================================================
# Monitoring & Observability Routes (Grafana, Langfuse, Prometheus)
# ============================================================================

# Grafana Dashboard
location ~ ^/grafana/?(.*)$ {
    limit_req zone=admin_limit burst=20 nodelay;

    proxy_pass http://grafana_backend/$1;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Path /grafana;

    # WebSocket for real-time updates
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_redirect off;
    proxy_redirect ~^http://([^/]+)/(.*)$ http://$http_host/grafana/$2;
    proxy_redirect ~^https://([^/]+)/(.*)$ https://$http_host/grafana/$2;

    proxy_connect_timeout 30s;
    proxy_read_timeout 120s;
}

location ~ ^/grafana/api/datasources/proxy {
    limit_req zone=api_limit burst=100 nodelay;

    proxy_pass http://grafana_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout 30s;
    proxy_read_timeout 120s;
}

# Langfuse (LLM Observability)
location ~ ^/langfuse/?(.*)$ {
    limit_req zone=admin_limit burst=20 nodelay;

    proxy_pass http://langfuse_backend/$1;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;

    # WebSocket for real-time updates
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_redirect off;
    proxy_redirect ~^http://([^/]+)/(.*)$ http://$http_host/langfuse/$2;
    proxy_redirect ~^https://([^/]+)/(.*)$ https://$http_host/langfuse/$2;

    proxy_connect_timeout 30s;
    proxy_read_timeout 120s;
}

# Prometheus API (for external tools)
location ~ ^/prometheus/?(.*)$ {
    limit_req zone=admin_limit burst=50 nodelay;

    proxy_pass http://prometheus_backend/$1;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_redirect off;
    proxy_redirect ~^http://([^/]+)/(.*)$ http://$http_host/prometheus/$2;
    proxy_redirect ~^https://([^/]+)/(.*)$ https://$http_host/prometheus/$2;

    proxy_connect_timeout 30s;
    proxy_read_timeout 60s;
}

# Loki API (for log queries)
location ~ ^/loki/?(.*)$ {
    limit_req zone=api_limit burst=50 nodelay;

    proxy_pass http://loki_backend/$1;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout 30s;
    proxy_read_timeout 60s;
}

# Metrics endpoint (Prometheus scrape target)
location ~ ^/metrics {
    limit_req zone=api_limit burst=10 nodelay;
    access_log off;

    # This is only for NGINX metrics, not exposed publicly
    allow 172.28.0.0/16;  # Only internal network
    allow 127.0.0.1;
    deny all;

    return 404;
}
